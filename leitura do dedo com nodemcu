#include <Wire.h>
#include "MAX30100_PulseOximeter.h"
#include "MAX30100.h"

#include "ESP8266WiFi.h"
#include <PubSubClient.h>

MAX30100 sensor;

#define REPORTING_PERIOD_MS     1000

//Variaveis
char mqtt_server [30];
char mqtt_port [6];
char id_leito [20];
#define mqtt_server "10.10.100.11"
#define mqtt_user "your_username"
#define mqtt_password "your_password"
#define id_leito "leito01"
#define mqtt_port "1883"
const char* ssid = "Trojan.exe";
const char* password = "200smt200";
float BatimentoCache = 0;
float BatimentoCache2 = 0;
int z;
WiFiClient espClient;
PubSubClient client(espClient); 

PulseOximeter pox;

uint32_t tsLastReport = 0;

// Callback (registered below) fired when a pulse is detected
void onBeatDetected()
{
    Serial.println("Beat!");
}

void setup()
{
      Serial.begin(115200);

    Serial.printf("Connecting to %s ", ssid);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED)
  {
    delay(500);
    Serial.print(".");
  }
  
  Serial.println(" connected");
  Serial.print ("conectando na rede local: "); //print na Serial da mensagem: Conectado na  !
  Serial.println (ssid); //print na serial o nome da rede
  Serial.print ("IP: "); //
  Serial.println(WiFi.localIP()); //print na Serial do IP que o dispositivo pegou na rede
  Serial.println();
  
  //inicio mqtt client
  int mqtt_port_b;
  mqtt_port_b = atoi(mqtt_port);
  Serial.println("o valor do ip server:");
  Serial.println(mqtt_server);
  Serial.println("o valor da porta:");
  Serial.println(mqtt_port_b);
  Serial.println("o valor do id do leito:");
  Serial.println(id_leito);
  Serial.println("Atribuindo Valores ao servidor mqtt:");
  client.setServer(mqtt_server, mqtt_port_b);
  Serial.println("Valores Atribuidos:");
  float temperature = sensor.retrieveTemperature();
  Serial.print("done, Temperatura Inicial =");
  Serial.print(temperature);
  Serial.println("C");

    Serial.print("Initializing pulse oximeter..");

    // Initialize the PulseOximeter instance
    // Failures are generally due to an improper I2C wiring, missing power supply
    // or wrong target chip
    if (!pox.begin()) {
        Serial.println("FAILED");
        for(;;);
    } else {
        Serial.println("SUCCESS");
    }

    // The default current for the IR LED is 50mA and it could be changed
    //   by uncommenting the following line. Check MAX30100_Registers.h for all the
    //   available options.
    pox.setIRLedCurrent(MAX30100_LED_CURR_30_6MA);

    // Register a callback for the beat detection
    pox.setOnBeatDetectedCallback(onBeatDetected);
}

void loop()
{
  int i = 0;
  while (i<1000000){
    // Make sure to call update as fast as possible
    pox.update();

     if (!client.connected()) {
    while (!client.connected()) {
    if (client.connect("ESP8266Client")) {
    } 
  }
}
  
    // Asynchronously dump heart rate and oxidation levels to the serial
    // For both, a value of 0 means "invalid"
    if (millis() - tsLastReport > REPORTING_PERIOD_MS) {
        Serial.print("Heart rate:");
        Serial.print(pox.getHeartRate());
        String bpm = (".bpm");
        String keyleito = id_leito + bpm;
        client.publish(String(keyleito).c_str(), String(pox.getHeartRate()).c_str(), true);
        Serial.print("bpm / SpO2:");
        Serial.print(pox.getSpO2());
        Serial.println("%");
        String SpO2 = (".SpO2");
        String keyleito2 = id_leito + SpO2;
        client.publish(String(keyleito2).c_str(), String(pox.getSpO2()).c_str(), true);
        BatimentoCache = pox.getHeartRate();

        float temperature = sensor.retrieveTemperature();
        Serial.print("Temperatura do sensor=");
        Serial.print(temperature);
        Serial.println("C");
        
        if ( BatimentoCache2 == BatimentoCache){
          Serial.println("IGUAL");
        i++;
        Serial.print (i);
        Serial.println ("- Batidas Iguais");
        z=0;
        }else {
          z++;
          Serial.print (z);
          Serial.println("- Batidas Diferentes");
          Serial.println("Zerando as batidas iguais.");
          i=0;
        }
        
        tsLastReport = millis();

    }
        
  }
  ESP.restart();
}
